<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>چت خصوصی</title>
    <style>
        body { font-family: Tahoma, sans-serif; background-color: #e5ddd5; margin: 0; height: 100vh; overflow: hidden; }
        
        /* هدر بالا */
        header { position: fixed; top: 0; left: 0; width: 100%; height: 50px; background-color: #075e54; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        
        /* فضای پیام‌ها */
        #chat-box { 
            margin-top: 50px; /* فاصله از هدر */
            margin-bottom: 70px; /* فاصله از کادر نوشتن */
            height: calc(100vh - 120px); 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        /* استایل پیام */
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; word-wrap: break-word; }
        .me { align-self: flex-end; background-color: #dcf8c6; border-bottom-left-radius: 8px; }
        .other { align-self: flex-start; background-color: #fff; border-bottom-right-radius: 8px; }
        .sender { font-size: 10px; color: #888; display: block; margin-bottom: 2px; }

        /* کادر نوشتن (اصلاح شده: چسبیده به پایین) */
        #input-area { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 60px; 
            background-color: #f0f0f0; 
            display: flex; 
            align-items: center; 
            padding: 5px; 
            box-sizing: border-box; 
            border-top: 1px solid #ccc; 
            z-index: 100;
        }
        
        input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; margin: 0 5px; font-family: inherit; }
        button { background-color: #075e54; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <header>گپ دوستانه ما</header>

    <div id="chat-box">
        <div class="msg other"><span class="sender">سیستم</span>به چت خوش آمدید!</div>
    </div>

    <div id="input-area">
        <input type="text" id="msg" placeholder="پیام..." autocomplete="off">
        <button onclick="sendMsg()">➤</button>
    </div>

    <script>
        // لینک سرور شما که قبلاً فرستادی
        const SERVER_URL = "https://rapid-fog-3a87.zareitahaofficial.workers.dev/"; 

        let myName = localStorage.getItem('chatName');
        if (!myName) {
            myName = "کاربر " + Math.floor(Math.random() * 100);
            localStorage.setItem('chatName', myName);
        }

        async function sendMsg() {
            const input = document.getElementById('msg');
            const text = input.value.trim();
            if (!text) return;

            addMessageToScreen(myName, text, true);
            input.value = '';

            try {
                await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: myName, text: text })
                });
            } catch (e) { alert("خطا در اتصال"); }
        }

        async function getMessages() {
            try {
                const res = await fetch(SERVER_URL);
                const messages = await res.json();
                const chatBox = document.getElementById('chat-box');
                
                // فقط اگر پیام جدیدی بود رفرش کن (ساده)
                if (chatBox.childElementCount <= 1 || messages.length > 0) {
                     // اینجا یک منطق ساده برای نمایش است
                     // برای سادگی کد، فعلاً پیام‌های تکراری را فیلتر نمی‌کنیم در این نسخه ساده
                     // اما شما پیام‌های ارسالی خودت را می‌بینی
                }
                 // کد دریافت ساده برای تست
                 messages.forEach(m => {
                    // منطق نمایش پیام‌ها (در نسخه حرفه‌ای کامل‌تر می‌شود)
                 });
            } catch (e) {}
        }
        
        // نسخه ساده شده برای اینکه فقط کار کند:
        // تابع اضافه کردن به صفحه
        function addMessageToScreen(name, text, isMe) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = 'msg ' + (isMe ? 'me' : 'other');
            div.innerHTML = `<span class="sender">${name}</span>${text}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // دریافت واقعی پیام‌ها
        setInterval(async () => {
             try {
                const res = await fetch(SERVER_URL);
                const data = await res.json();
                const box = document.getElementById('chat-box');
                // پاک کردن و دوباره کشیدن برای هماهنگی کامل
                if(data.length > 0) {
                    box.innerHTML = ''; 
                    data.forEach(m => {
                        addMessageToScreen(m.name, m.text, m.name === myName);
                    });
                }
             } catch(e) {}
        }, 2000);

        document.getElementById("msg").addEventListener("keypress", function(e) {
            if (e.key === "Enter") sendMsg();
        });
    </script>
</body>
</html>
