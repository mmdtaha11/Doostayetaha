<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>چت خصوصی</title>
    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100dvh; width: 100%; font-family: Tahoma, sans-serif; background-color: #e5ddd5; overflow: hidden; }
        
        /* عمومی */
        button { cursor: pointer; border: none; font-family: inherit; }
        .hidden { display: none !important; }

        /* صفحه ورود */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #075e54; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: white; }
        .login-box { background: white; padding: 25px; border-radius: 15px; display: flex; flex-direction: column; gap: 15px; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 16px; background: #f9f9f9; outline: none; color: black; }
        .login-btn { padding: 12px; background: #25D366; color: white; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .admin-link { margin-top: 15px; font-size: 12px; color: rgba(255,255,255,0.7); text-decoration: underline; cursor: pointer; }

        /* پنل مدیریت */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 3000; display: flex; flex-direction: column; }
        .admin-header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-list { flex: 1; overflow-y: auto; padding: 20px; }
        .user-row { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: black; }
        .ban-btn { background: #ff4444; color: white; padding: 5px 15px; border-radius: 5px; font-size: 12px; }

        /* صفحه چت */
        #main-app { display: none; flex-direction: column; height: 100dvh; }
        header { height: 60px; background-color: #075e54; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; position: relative; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 14px; word-wrap: break-word; line-height: 1.5; }
        .me { align-self: flex-end; background-color: #dcf8c6; border-bottom-left-radius: 12px; }
        .other { align-self: flex-start; background-color: #fff; border-bottom-right-radius: 12px; }
        .sender { font-size: 10px; color: #888; display: block; margin-bottom: 4px; font-weight: bold; }
        #input-area { height: 70px; background-color: #f0f0f0; display: flex; align-items: center; padding: 0 10px; border-top: 1px solid #ccc; flex-shrink: 0; }
        #msg-input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; margin-left: 10px; font-size: 16px; }
        .send-btn { background-color: #075e54; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h3 style="text-align:center; margin:0; color:#075e54;">گپ خصوصی</h3>
            <input type="text" id="username" class="login-input" placeholder="نام کاربری">
            <button class="login-btn" onclick="attemptLogin()">ورود</button>
            <p id="error-text" style="color:red; font-size:12px; text-align:center; display:none;"></p>
        </div>
        <span class="admin-link" onclick="showAdminLogin()">ورود مدیر</span>
    </div>

    <div id="admin-panel" class="hidden">
        <div class="admin-header">
            <span>پنل مدیریت</span>
            <button onclick="closeAdmin()" style="background:none; color:white; font-size:20px;">✕</button>
        </div>
        <div class="user-list" id="admin-list">
            <p style="text-align:center; color:#777;">در حال دریافت لیست...</p>
        </div>
        <button onclick="fetchUsersForAdmin()" style="margin:10px; padding:15px; background:#075e54; color:white; border-radius:10px;">بروزرسانی لیست</button>
    </div>

    <div id="main-app">
        <header>گپ دوستانه</header>
        <div id="chat-box"></div>
        <div id="input-area">
            <button class="send-btn" onclick="sendMsg()">➤</button>
            <input type="text" id="msg-input" placeholder="پیام..." autocomplete="off">
        </div>
    </div>

    <script>
        // ✅ آدرس سرور وی‌پی‌اس شما
        const SERVER_URL = "http://167.71.122.10/"; 
        const ADMIN_PASS = "taha"; 

        let myName = "";

        // --- بخش ورود ---
        async function attemptLogin() {
            const userIn = document.getElementById('username').value.trim();
            const btn = document.querySelector('.login-btn');

            if (userIn.length < 3) return showError("نام کاربری کوتاه است!");

            btn.innerText = "...";
            try {
                // درخواست ثبت نام به سرور جدید
                const res = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'register', name: userIn })
                });

                if (res.status === 403) return showError("متاسفم! شما بن شده‌اید.");
                if (res.status === 409) return showError("این نام قبلاً گرفته شده.");
                
                if (res.ok) {
                    myName = userIn;
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                    startSync();
                } else {
                    showError("خطا در اتصال به سرور");
                }
            } catch (e) { 
                console.log(e);
                showError("اتصال برقرار نشد! (فیلترشکن یا تنظیمات Mixed Content را چک کنید)"); 
            }
            btn.innerText = "ورود";
        }

        // --- بخش مدیریت ---
        function showAdminLogin() {
            const pass = prompt("رمز مدیریت:");
            if (pass === ADMIN_PASS) {
                document.getElementById('admin-panel').classList.remove('hidden');
                fetchUsersForAdmin();
            }
        }

        function closeAdmin() {
            document.getElementById('admin-panel').classList.add('hidden');
        }

        async function fetchUsersForAdmin() {
            const listDiv = document.getElementById('admin-list');
            try {
                const res = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'admin_action', action: 'get_users', adminPass: ADMIN_PASS })
                });
                const data = await res.json();
                
                listDiv.innerHTML = "";
                if (!data.users || data.users.length === 0) listDiv.innerHTML = "<p style='text-align:center'>هیچ کاربری نیست</p>";

                data.users.forEach(u => {
                    listDiv.innerHTML += `
                        <div class="user-row">
                            <strong>${u}</strong>
                            <button class="ban-btn" onclick="banUser('${u}')">BAN ⛔</button>
                        </div>
                    `;
                });
            } catch (e) { listDiv.innerHTML = "خطا در دریافت لیست"; }
        }

        async function banUser(targetName) {
            if(!confirm(`بن کردن ${targetName}؟`)) return;
            await fetch(SERVER_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    type: 'admin_action', 
                    action: 'ban_user', 
                    adminPass: ADMIN_PASS, 
                    targetName: targetName 
                })
            });
            alert("انجام شد");
            fetchUsersForAdmin();
        }

        function showError(msg) {
            const el = document.getElementById('error-text');
            el.innerText = msg;
            el.style.display = 'block';
        }

        // --- بخش چت ---
        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;
            
            // ذخیره مقدار و پاک کردن ورودی برای حس سرعت
            const tempText = text; 
            input.value = '';

            try {
                const res = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'message', name: myName, text: tempText })
                });
                if(res.status === 403) { alert("شما بن شدید!"); location.reload(); }
                loadMessages();
            } catch (e) { alert("ارسال نشد"); input.value = tempText; }
        }

        async function loadMessages() {
            try {
                const res = await fetch(SERVER_URL);
                const data = await res.json();
                const chatBox = document.getElementById('chat-box');
                
                let content = "";
                data.forEach(m => {
                    const isMe = m.name === myName;
                    content += `<div class="msg ${isMe ? 'me' : 'other'}">
                        <span class="sender">${m.name}</span>${m.text}</div>`;
                });
                
                if (chatBox.innerHTML !== content) {
                    chatBox.innerHTML = content;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (e) {}
        }

        function startSync() {
            loadMessages();
            setInterval(loadMessages, 2000);
        }

        document.getElementById("msg-input").addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMsg();
        });
    </script>
</body>
</html>
